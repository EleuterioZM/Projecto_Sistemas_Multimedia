/**
 * @package     Joomla.Plugin
 * @subpackage  Multifactorauth.webauthn
 *
 * @copyright   (C) 2022 Open Source Matters, Inc. <https://www.joomla.org>
 * @license     GNU General Public License version 2 or later; see LICENSE.txt
 */((s,a)=>{let c=null;const i=t=>btoa(String.fromCharCode(...t)),l=t=>{let e=t.replace(/-/g,"+").replace(/_/g,"/");const r=e.length%4;if(r){if(r===1)throw new Error("InvalidLengthError: Input base64url string is the wrong length to determine padding");e+=new Array(5-r).join("=")}return e},o=t=>{try{s.renderMessages({error:t})}catch{alert(t)}},d=t=>{try{a.getElementById("plg_multifactorauth_webauthn_validate_button").style.disabled="null"}catch{}o(t)},y=t=>{if(t.preventDefault(),!("credentials"in navigator))return o(s.Text._("PLG_MULTIFACTORAUTH_WEBAUTHN_ERR_NOTAVAILABLE_HEAD")),!1;const e=a.forms["com-users-method-edit"].querySelectorAll('input[name="pkRequest"]')[0].value,r=JSON.parse(atob(e));return r.challenge=Uint8Array.from(window.atob(l(r.challenge)),n=>n.charCodeAt(0)),r.user.id=Uint8Array.from(window.atob(r.user.id),n=>n.charCodeAt(0)),r.excludeCredentials&&(r.excludeCredentials=r.excludeCredentials.map(n=>(n.id=Uint8Array.from(window.atob(l(n.id)),u=>u.charCodeAt(0)),n))),navigator.credentials.create({publicKey:r}).then(n=>{const u={id:n.id,type:n.type,rawId:i(new Uint8Array(n.rawId)),response:{clientDataJSON:i(new Uint8Array(n.response.clientDataJSON)),attestationObject:i(new Uint8Array(n.response.attestationObject))}};a.getElementById("com-users-method-code").value=btoa(JSON.stringify(u)),a.forms["com-users-method-edit"].submit()},n=>{d(n)}),!1},p=()=>{if(!("credentials"in navigator)){o(s.Text._("PLG_MULTIFACTORAUTH_WEBAUTHN_ERR_NOTAVAILABLE_HEAD"));return}const t=c;if(!t.challenge){d(s.Text._("PLG_MULTIFACTORAUTH_WEBAUTHN_ERR_NO_STORED_CREDENTIAL"));return}t.challenge=Uint8Array.from(window.atob(l(t.challenge)),e=>e.charCodeAt(0)),t.allowCredentials&&(t.allowCredentials=t.allowCredentials.map(e=>(e.id=Uint8Array.from(window.atob(l(e.id)),r=>r.charCodeAt(0)),e))),navigator.credentials.get({publicKey:t}).then(e=>{const r={id:e.id,type:e.type,rawId:i(new Uint8Array(e.rawId)),response:{authenticatorData:i(new Uint8Array(e.response.authenticatorData)),clientDataJSON:i(new Uint8Array(e.response.clientDataJSON)),signature:i(new Uint8Array(e.response.signature)),userHandle:e.response.userHandle?i(new Uint8Array(e.response.userHandle)):null}};a.getElementById("users-mfa-code").value=btoa(JSON.stringify(r)),a.getElementById("users-mfa-captive-form").submit()},e=>{d(e)})},g=t=>(t.preventDefault(),c=JSON.parse(window.atob(s.getOptions("com_users.authData"))),a.getElementById("users-mfa-captive-button-submit").style.disabled="disabled",p(),!1);a.getElementById("multifactorauth-webauthn-missing").style.display="none",typeof navigator.credentials>"u"&&(a.getElementById("multifactorauth-webauthn-missing").style.display="block",a.getElementById("multifactorauth-webauthn-controls").style.display="none"),window.addEventListener("DOMContentLoaded",()=>{s.getOptions("com_users.pagetype")==="validate"?a.getElementById("users-mfa-captive-button-submit").addEventListener("click",g):a.querySelectorAll(".multifactorauth_webauthn_setup").forEach(t=>{t.addEventListener("click",y)})})})(Joomla,document);
