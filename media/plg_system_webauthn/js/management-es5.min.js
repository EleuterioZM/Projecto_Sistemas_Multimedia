(function(){"use strict";/**
 * @package     Joomla.Plugin
 * @subpackage  System.webauthn
 *
 * @copyright   (C) 2020 Open Source Matters, Inc. <https://www.joomla.org>
 * @license     GNU General Public License version 2 or later; see LICENSE.txt
 */window.Joomla=window.Joomla||{},function(t,f){var S=function n(i,e){e===void 0&&(e="");var a="";return Object.keys(i).forEach(function(s){if(typeof i[s]!="object"){a.length>0&&(a+="&"),e===""?a+=encodeURIComponent(s)+"="+encodeURIComponent(i[s]):a+=encodeURIComponent(e)+"["+encodeURIComponent(s)+"]="+encodeURIComponent(i[s]);return}a+=""+n(i[s],s)}),a},E=function(i){t.renderMessages({error:[i]})};t.plgSystemWebauthnInitCreateCredentials=function(){if(!("credentials"in navigator)){t.renderMessages({error:[t.Text._("PLG_SYSTEM_WEBAUTHN_ERR_NO_BROWSER_SUPPORT")]});return}var n=t.getOptions("system.paths"),i=""+(n?n.base+"/index.php":window.location.pathname),e={option:"com_ajax",group:"system",plugin:"webauthn",format:"json",akaction:"initcreate",encoding:"json"};e[t.getOptions("csrf.token")]=1,t.request({url:i,method:"POST",data:S(e),onSuccess:function(s){try{var r=JSON.parse(s);t.plgSystemWebauthnCreateCredentials(r)}catch{E(t.Text._("PLG_SYSTEM_WEBAUTHN_ERR_XHR_INITCREATE"))}},onError:function(s){E(s.status+" "+s.statusText)}})},t.plgSystemWebauthnCreateCredentials=function(n){var i=t.getOptions("system.paths"),e=""+(i?i.base+"/index.php":window.location.pathname),a=function(l){return btoa(String.fromCharCode.apply(String,l))},s=function(l){var o=l.replace(/-/g,"+").replace(/_/g,"/"),c=o.length%4;if(c){if(c===1)throw new Error("InvalidLengthError: Input base64url string is the wrong length to determine padding");o+=new Array(5-c).join("=")}return o};n.challenge=Uint8Array.from(window.atob(s(n.challenge)),function(r){return r.charCodeAt(0)}),n.user.id=Uint8Array.from(window.atob(n.user.id),function(r){return r.charCodeAt(0)}),n.excludeCredentials&&(n.excludeCredentials=n.excludeCredentials.map(function(r){return r.id=Uint8Array.from(window.atob(s(r.id)),function(l){return l.charCodeAt(0)}),r})),navigator.credentials.create({publicKey:n}).then(function(r){var l={id:r.id,type:r.type,rawId:a(new Uint8Array(r.rawId)),response:{clientDataJSON:a(new Uint8Array(r.response.clientDataJSON)),attestationObject:a(new Uint8Array(r.response.attestationObject))}},o={option:"com_ajax",group:"system",plugin:"webauthn",format:"raw",akaction:"create",encoding:"raw",data:btoa(JSON.stringify(l))};o[t.getOptions("csrf.token")]=1,t.request({url:e,method:"POST",data:S(o),onSuccess:function(u){var g=f.querySelectorAll("#plg_system_webauthn-management-interface");if(g){var h=g[0];h.outerHTML=u,t.plgSystemWebauthnInitialize(),t.plgSystemWebauthnReactivateTooltips()}},onError:function(u){E(u.status+" "+u.statusText)}})}).catch(function(r){E(r)})},t.plgSystemWebauthnEditLabel=function(n){var i=t.getOptions("system.paths"),e=""+(i?i.base+"/index.php":window.location.pathname),a=n.parentElement.parentElement,s=a.dataset.credential_id,r=a.querySelectorAll(".webauthnManagementCell"),l=r[0],o=r[1],c=o.querySelectorAll("button"),u=c[0],g=c[1],h=l.innerText,d=f.createElement("div");d.className="webauthnManagementEditorRow d-flex gap-2";var p=f.createElement("input");p.type="text",p.name="label",p.defaultValue=h,p.className="form-control";var b=f.createElement("button");b.className="btn btn-success btn-sm",b.innerText=t.Text._("PLG_SYSTEM_WEBAUTHN_MANAGE_BTN_SAVE_LABEL"),b.addEventListener("click",function(){var T=p.value;if(T!==""){var y={option:"com_ajax",group:"system",plugin:"webauthn",format:"json",encoding:"json",akaction:"savelabel",credential_id:s,new_label:T};y[t.getOptions("csrf.token")]=1,t.request({url:e,method:"POST",data:S(y),onSuccess:function(_){var m=!1;try{m=JSON.parse(_)}catch{m=_==="true"}m!==!0&&E(t.Text._("PLG_SYSTEM_WEBAUTHN_ERR_LABEL_NOT_SAVED"))},onError:function(_){E(t.Text._("PLG_SYSTEM_WEBAUTHN_ERR_LABEL_NOT_SAVED")+" -- "+_.status+" "+_.statusText)}})}return l.innerText=T,u.disabled=!1,g.disabled=!1,!1},!1);var v=f.createElement("button");return v.className="btn btn-danger btn-sm",v.innerText=t.Text._("PLG_SYSTEM_WEBAUTHN_MANAGE_BTN_CANCEL_LABEL"),v.addEventListener("click",function(){return l.innerText=h,u.disabled=!1,g.disabled=!1,!1},!1),l.innerHTML="",d.appendChild(p),d.appendChild(b),d.appendChild(v),l.appendChild(d),u.disabled=!0,g.disabled=!0,!1},t.plgSystemWebauthnDelete=function(n){if(!window.confirm(t.Text._("JGLOBAL_CONFIRM_DELETE")))return!1;var i=t.getOptions("system.paths"),e=""+(i?i.base+"/index.php":window.location.pathname),a=n.parentElement.parentElement,s=a.dataset.credential_id,r=a.querySelectorAll(".webauthnManagementCell"),l=r[1],o=l.querySelectorAll("button"),c=o[0],u=o[1];c.disabled=!0,u.disabled=!0;var g={option:"com_ajax",group:"system",plugin:"webauthn",format:"json",encoding:"json",akaction:"delete",credential_id:s};return g[t.getOptions("csrf.token")]=1,t.request({url:e,method:"POST",data:S(g),onSuccess:function(d){var p=!1;try{p=JSON.parse(d)}catch{p=d==="true"}if(p!==!0){E(t.Text._("PLG_SYSTEM_WEBAUTHN_ERR_NOT_DELETED"));return}a.parentElement.removeChild(a)},onError:function(d){c.disabled=!1,u.disabled=!1,E(t.Text._("PLG_SYSTEM_WEBAUTHN_ERR_NOT_DELETED")+" -- "+d.status+" "+d.statusText)}}),!1},t.plgSystemWebauthnReactivateTooltips=function(){var n=t.getOptions("bootstrap.tooltip");typeof n=="object"&&n!==null&&Object.keys(n).forEach(function(i){var e=n[i],a={animation:e.animation?e.animation:!0,container:e.container?e.container:!1,delay:e.delay?e.delay:0,html:e.html?e.html:!1,selector:e.selector?e.selector:!1,trigger:e.trigger?e.trigger:"hover focus",fallbackPlacement:e.fallbackPlacement?e.fallbackPlacement:null,boundary:e.boundary?e.boundary:"clippingParents",title:e.title?e.title:"",customClass:e.customClass?e.customClass:"",sanitize:e.sanitize?e.sanitize:!0,sanitizeFn:e.sanitizeFn?e.sanitizeFn:null,popperConfig:e.popperConfig?e.popperConfig:null};e.placement&&(a.placement=e.placement),e.template&&(a.template=e.template),e.allowList&&(a.allowList=e.allowList);var s=Array.from(f.querySelectorAll(i));s.length&&s.map(function(r){return new window.bootstrap.Tooltip(r,a)})})},t.plgSystemWebauthnAddOnClick=function(n){return n.preventDefault(),t.plgSystemWebauthnInitCreateCredentials(),!1},t.plgSystemWebauthnEditOnClick=function(n){return n.preventDefault(),t.plgSystemWebauthnEditLabel(n.currentTarget),!1},t.plgSystemWebauthnDeleteOnClick=function(n){return n.preventDefault(),t.plgSystemWebauthnDelete(n.currentTarget),!1},t.plgSystemWebauthnInitialize=function(){var n=f.getElementById("plg_system_webauthn-manage-add");n&&n.addEventListener("click",t.plgSystemWebauthnAddOnClick);var i=[].slice.call(f.querySelectorAll(".plg_system_webauthn-manage-edit"));i.length&&i.forEach(function(a){a.addEventListener("click",t.plgSystemWebauthnEditOnClick)});var e=[].slice.call(f.querySelectorAll(".plg_system_webauthn-manage-delete"));e.length&&e.forEach(function(a){a.addEventListener("click",t.plgSystemWebauthnDeleteOnClick)})},t.plgSystemWebauthnInitialize()}(Joomla,document)})();
