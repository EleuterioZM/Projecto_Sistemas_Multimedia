/**
 * @copyright   (C) 2012 Open Source Matters, Inc. <https://www.joomla.org>
 * @license     GNU General Public License version 2 or later; see LICENSE.txt
 */Joomla=window.Joomla||{},((l,i)=>{l.submitbuttonUpload=()=>{const t=i.getElementById("uploadForm"),s=i.getElementById("joomlaupdate-confirm-backup");t.install_package.value===""?alert(l.Text._("COM_INSTALLER_MSG_INSTALL_PLEASE_SELECT_A_PACKAGE"),!0):t.install_package.files[0].size>t.max_upload_size.value?alert(l.Text._("COM_INSTALLER_MSG_WARNINGS_UPLOADFILETOOBIG"),!0):s&&s.checked&&t.submit()},l.installpackageChange=()=>{const t=i.getElementById("uploadForm"),s=t.install_package.files[0].size,a=s*1/1024/1024,n=i.getElementById("file_size"),r=i.getElementById("max_upload_size_warn");t.install_package.value===""?(n.classList.add("hidden"),r.classList.add("hidden")):s&&(n.classList.remove("hidden"),n.innerHTML=l.sanitizeHtml(l.Text._("JGLOBAL_SELECTED_UPLOAD_FILE_SIZE").replace("%s",`${a.toFixed(2)} MB`)),s>t.max_upload_size.value?r.classList.remove("hidden"):r.classList.add("hidden"))},i.addEventListener("DOMContentLoaded",()=>{const t=i.getElementById("confirmButton"),s=i.getElementById("uploadForm"),a=i.getElementById("uploadButton"),n=i.getElementById("install_package"),r=i.querySelector(".emptystate-btnadd",i.getElementById("joomlaupdate-wrapper")),e=i.getElementById("joomlaupdate-confirm-backup"),o=r?r.closest("form"):null,c=o?o.querySelector("[name=task]",o):null;a&&(a.addEventListener("click",l.submitbuttonUpload),a.disabled=e&&!e.checked,e&&e.addEventListener("change",()=>{a.disabled=!e.checked})),t&&e&&!e.checked&&t.classList.add("disabled"),t&&e&&e.addEventListener("change",()=>{e.checked?t.classList.remove("disabled"):t.classList.add("disabled")}),n&&(n.addEventListener("change",l.installpackageChange),e&&n.addEventListener("change",()=>{const d=s.install_package.files[0].size,E=s.max_upload_size.value;d<=E&&e.disabled?e.disabled=!e.disabled:d<=E&&!e.disabled&&!e.checked?e.disabled=!1:d<=E&&e.checked?(e.checked=e.classList.contains("d-none"),a.disabled=!0):d>E&&!e.disabled&&(e.disabled=!e.disabled,e.checked=e.classList.contains("d-none"),a.disabled=!0)})),r&&r.getAttribute("href")==="#"&&c&&r.addEventListener("click",d=>{d.preventDefault(),!(e&&!e.checked)&&(c.value="update.download",o.submit())})})})(Joomla,document),((l,i)=>{const t={};t.config={serverUrl:"index.php?option=com_joomlaupdate&task=update.fetchextensioncompatibility",batchUrl:"index.php?option=com_joomlaupdate&task=update.batchextensioncompatibility",selector:".extension-check"},t.STATE={INCOMPATIBLE:0,COMPATIBLE:1,MISSING_COMPATIBILITY_TAG:2,SERVER_ERROR:3},t.cleanup=s=>{const a=i.querySelector("#joomlaupdate-precheck-extensions-tab .fa-spinner");let n="success",r="check";switch(s){case"danger":n="danger",r="times";break;case"warning":n="warning",r="exclamation-triangle";break}a&&(a.classList.remove("fa-spinner","fa-spin"),a.classList.add(`fa-${r}`,`text-${n}`,"bg-white"));const e=i.querySelector("#compatibilityTable0"),o=i.querySelector("#preupdateCheckWarning");e&&e.classList.add("hidden"),o&&o.classList.add("hidden")},t.run=()=>{t.nonCoreCriticalPlugins=l.getOptions("nonCoreCriticalPlugins",[]);const s=i.querySelectorAll(t.config.selector);if(s.length===0){i.getElementById("preupdatecheckbox")!==null&&(i.getElementById("preupdatecheckbox").style.display="none"),i.getElementById("noncoreplugins")!==null&&(i.getElementById("noncoreplugins").checked=!0),[].slice.call(i.querySelectorAll("button.submitupdate")).forEach(e=>{e.classList.remove("disabled"),e.removeAttribute("disabled")}),t.cleanup();return}const a=()=>{const e=i.getElementById("noncoreplugins");e.checked?window.confirm(l.Text._("COM_JOOMLAUPDATE_VIEW_DEFAULT_POTENTIALLY_DANGEROUS_PLUGIN_CONFIRM_MESSAGE"))?[].slice.call(i.querySelectorAll("button.submitupdate")).forEach(o=>{o.classList.remove("disabled"),o.removeAttribute("disabled")}):e.checked=!1:[].slice.call(i.querySelectorAll("button.submitupdate")).forEach(o=>{o.classList.add("disabled"),o.setAttribute("disabled","")})};i.getElementById("noncoreplugins")!==null&&i.getElementById("noncoreplugins").addEventListener("change",a);const n=i.getElementById("joomlaupdate-wrapper");t.joomlaTargetVersion=n.getAttribute("data-joomla-target-version"),t.joomlaCurrentVersion=n.getAttribute("data-joomla-current-version"),[].slice.call(i.querySelectorAll(".compatibilitytoggle")).forEach(e=>{e.addEventListener("click",()=>{const o=e.closest(".compatibilityTable");e.dataset.state==="closed"?(e.dataset.state="open",e.innerHTML=l.sanitizeHtml(l.Text._("COM_JOOMLAUPDATE_VIEW_DEFAULT_EXTENSIONS_SHOW_LESS_COMPATIBILITY_INFORMATION")),[].slice.call(o.querySelectorAll("table .hidden")).forEach(c=>{c.classList.remove("hidden")})):(e.dataset.state="closed",e.innerHTML=l.sanitizeHtml(l.Text._("COM_JOOMLAUPDATE_VIEW_DEFAULT_EXTENSIONS_SHOW_MORE_COMPATIBILITY_INFORMATION")),[].slice.call(o.querySelectorAll("table .instver, table .upcomp, table .currcomp")).forEach(c=>{c.classList.add("hidden")}))})});const r=[];[].slice.call(s).forEach(e=>{const o={eid:e.getAttribute("data-extension-id"),version:e.getAttribute("data-extension-current-version")};r.push(o)}),t.checkNextChunk(r)},t.interpolateParameters=(s,a)=>{let n="";return typeof s!="object"||s===null||!s?"":(Object.keys(s).forEach(r=>{const e=s[r];if(n.length>0&&(n+="&"),typeof e=="object"){const o=a.length?`${a}[${r}]`:r;n+=t.interpolateParameters(e,o);return}if(a===""){n+=`${encodeURIComponent(r)}=${encodeURIComponent(e)}`;return}n+=`${encodeURIComponent(a)}[${encodeURIComponent(r)}]=${encodeURIComponent(e)}`}),n)},t.checkNextChunk=s=>{s.length!==0&&l.request({url:t.config.batchUrl,method:"POST",data:t.interpolateParameters({"joomla-target-version":t.joomlaTargetVersion,"joomla-current-version":t.joomlaCurrentVersion,extensions:s},""),onSuccess(a){const n=JSON.parse(a);n.messages&&l.renderMessages(n.messages);const r=n.data.extensions||[];n.data.compatibility.forEach(e=>{const o=i.getElementById(`preUpdateCheck_${e.id}`);o&&t.setResultView({element:o,compatibleVersion:0,serverError:0,compatibilityData:e})}),t.checkNextChunk(r)},onError(a){l.renderMessages(l.ajaxErrorsMessages(a)),s.forEach(n=>{const r=i.getElementById(`preUpdateCheck_${n.eid}`);r&&t.setResultView({element:r,compatibleVersion:0,serverError:1})})}})},t.checkCompatibility=s=>{const a={element:s,compatibleVersion:0,serverError:1};l.request({url:`${t.config.serverUrl}&joomla-target-version=${encodeURIComponent(t.joomlaTargetVersion)}&joomla-current-version=${t.joomlaCurrentVersion}&extension-version=${s.getAttribute("data-extension-current-version")}&extension-id=${encodeURIComponent(s.getAttribute("data-extension-id"))}`,onSuccess(n){const r=JSON.parse(n);a.serverError=0,a.compatibilityData=r.data,t.setResultView(a)},onError(){a.serverError=1,t.setResultView(a)}})},t.setResultView=s=>{let a="";if(s.serverError)a=l.Text._("COM_JOOMLAUPDATE_VIEW_DEFAULT_EXTENSION_SERVER_ERROR"),s.compatibilityData={resultGroup:4};else switch(s.compatibilityData.upgradeCompatibilityStatus.state){case t.STATE.COMPATIBLE:s.compatibilityData.upgradeWarning?a=`<span class="label label-warning">${l.sanitizeHtml(s.compatibilityData.upgradeCompatibilityStatus.compatibleVersion)}</span>`:a=s.compatibilityData.upgradeCompatibilityStatus.compatibleVersion===!1?l.Text._("COM_JOOMLAUPDATE_VIEW_DEFAULT_EXTENSION_NO_COMPATIBILITY_INFORMATION"):l.sanitizeHtml(s.compatibilityData.upgradeCompatibilityStatus.compatibleVersion);break;case t.STATE.INCOMPATIBLE:a=l.Text._("COM_JOOMLAUPDATE_VIEW_DEFAULT_EXTENSION_NO_COMPATIBILITY_INFORMATION");break;case t.STATE.MISSING_COMPATIBILITY_TAG:a=l.Text._("COM_JOOMLAUPDATE_VIEW_DEFAULT_EXTENSION_NO_COMPATIBILITY_INFORMATION");break;default:a=l.Text._("COM_JOOMLAUPDATE_VIEW_DEFAULT_EXTENSION_WARNING_UNKNOWN")}if(s.element.innerHTML=a,a="",s.serverError)a=l.Text._("COM_JOOMLAUPDATE_VIEW_DEFAULT_EXTENSION_SERVER_ERROR");else switch(s.compatibilityData.currentCompatibilityStatus.state){case t.STATE.COMPATIBLE:a=s.compatibilityData.currentCompatibilityStatus.compatibleVersion===!1?l.Text._("COM_JOOMLAUPDATE_VIEW_DEFAULT_EXTENSION_NO_COMPATIBILITY_INFORMATION"):s.compatibilityData.currentCompatibilityStatus.compatibleVersion;break;case t.STATE.INCOMPATIBLE:a=l.Text._("COM_JOOMLAUPDATE_VIEW_DEFAULT_EXTENSION_NO_COMPATIBILITY_INFORMATION");break;case t.STATE.MISSING_COMPATIBILITY_TAG:a=l.Text._("COM_JOOMLAUPDATE_VIEW_DEFAULT_EXTENSION_NO_COMPATIBILITY_INFORMATION");break;default:a=l.Text._("COM_JOOMLAUPDATE_VIEW_DEFAULT_EXTENSION_WARNING_UNKNOWN")}const n=s.element.getAttribute("data-extension-id");i.getElementById(`available-version-${n}`).innerText=a;const r=i.querySelector(`#compatibilityTable${s.compatibilityData.resultGroup} tbody`);if(r&&r.appendChild(s.element.closest("tr")),i.getElementById(`compatibilityTable${s.compatibilityData.resultGroup}`).classList.remove("hidden"),s.compatibilityData.resultGroup===3&&(t.nonCoreCriticalPlugins=t.nonCoreCriticalPlugins.filter(e=>!(e.package_id.toString()===n||e.extension_id.toString()===n))),!i.querySelector("#compatibilityTable0 tbody td")){i.getElementById("compatibilityTable0").classList.add("hidden");let e="success";t.nonCoreCriticalPlugins.forEach(o=>{let c=i.querySelector(`td[data-extension-id="${o.extension_id}"]`);if(c||(c=i.querySelector(`td[data-extension-id="${o.package_id}"]`)),c){const d=c.closest("tr");d.classList.add("error");const E=d.querySelector(".exname");E.innerHTML=`${l.sanitizeHtml(E.innerHTML)}
              <div class="small">
              ${i.querySelector(`td[data-extension-id="${o.extension_id}"]`)?"":` - ${o.name}`}
              <span class="badge bg-warning">
              <span class="icon-warning"></span>
              ${l.Text._("COM_JOOMLAUPDATE_VIEW_DEFAULT_POTENTIALLY_DANGEROUS_PLUGIN")}
              </span>

              <button type="button" class="btn btn-sm btn-link hasPopover"
              title="${l.Text._("COM_JOOMLAUPDATE_VIEW_DEFAULT_POTENTIALLY_DANGEROUS_PLUGIN")} "
              data-bs-content="${l.Text._("COM_JOOMLAUPDATE_VIEW_DEFAULT_POTENTIALLY_DANGEROUS_PLUGIN_DESC")} "
              >
              ${l.Text._("COM_JOOMLAUPDATE_VIEW_DEFAULT_HELP")}
              </button>
              </div>`;const _=E.querySelector(".hasPopover");_&&(_.style.cursor="pointer",new bootstrap.Popover(_,{placement:"top",html:!0,trigger:"focus"})),e="danger"}}),i.querySelector("#compatibilityTable2 tbody td")?e="danger":e!=="danger"&&i.querySelector("#compatibilityTable1 tbody td")&&(e="warning"),t.nonCoreCriticalPlugins.length===0&&e==="success"&&i.getElementById("preupdatecheckbox")&&(i.getElementById("preupdatecheckbox").style.display="none"),t.nonCoreCriticalPlugins.length===0&&e==="success"&&i.getElementById("noncoreplugins")&&(i.getElementById("noncoreplugins").checked=!0),t.nonCoreCriticalPlugins.length===0&&e==="success"?[].slice.call(i.querySelectorAll("button.submitupdate")).forEach(o=>{o.classList.remove("disabled"),o.removeAttribute("disabled")}):t.nonCoreCriticalPlugins.length>0&&i.getElementById("preupdateCheckCompleteProblems").classList.remove("hidden"),t.cleanup(e)}},i.getElementById("preupdatecheck")!==null&&i.addEventListener("DOMContentLoaded",t.run,!1)})(Joomla,document);
