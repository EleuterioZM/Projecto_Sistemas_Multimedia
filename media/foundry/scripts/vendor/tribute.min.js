FD.module("vendor/tribute",function(e){var n=this;FD.require().done(function(){var e,t;e=this,t=function(){"use strict";function A(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function i(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function e(e,t,n){return t&&i(e.prototype,t),n&&i(e,n),e}function u(e,t){return function(e){if(Array.isArray(e))return e}(e)||function(e,t){if("undefined"!=typeof Symbol&&Symbol.iterator in Object(e)){var n=[],i=!0,r=!1,o=void 0;try{for(var u,l=e[Symbol.iterator]();!(i=(u=l.next()).done)&&(n.push(u.value),!t||n.length!==t);i=!0);}catch(e){r=!0,o=e}finally{try{i||null==l.return||l.return()}finally{if(r)throw o}}return n}}(e,t)||function(e,t){if(e){if("string"==typeof e)return r(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);return"Map"===(n="Object"===n&&e.constructor?e.constructor.name:n)||"Set"===n?Array.from(n):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?r(e,t):void 0}}(e,t)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function r(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,i=new Array(t);n<t;n++)i[n]=e[n];return i}var t;Array.prototype.find||(Array.prototype.find=function(e){if(null===this)throw new TypeError("Array.prototype.find called on null or undefined");if("function"!=typeof e)throw new TypeError("predicate must be a function");for(var t,n=Object(this),i=n.length>>>0,r=arguments[1],o=0;o<i;o++)if(t=n[o],e.call(r,t,o,n))return t}),window&&"function"!=typeof window.CustomEvent&&(t=function(e,t){t=t||{bubbles:!1,cancelable:!1,detail:void 0};var n=document.createEvent("CustomEvent");return n.initCustomEvent(e,t.bubbles,t.cancelable,t.detail),n},void 0!==window.Event&&(t.prototype=window.Event.prototype),window.CustomEvent=t);var L=function(){function r(e){A(this,r),this.tribute=e,this.tribute.events=this}return e(r,[{key:"bind",value:function(e){e.boundKeydown=this.keydown.bind(e,this),e.boundKeyup=this.keyup.bind(e,this),e.boundInput=this.input.bind(e,this),e.addEventListener("keydown",e.boundKeydown,!1),e.addEventListener("keyup",e.boundKeyup,!1),e.addEventListener("input",e.boundInput,!1)}},{key:"unbind",value:function(e){e.removeEventListener("keydown",e.boundKeydown,!1),e.removeEventListener("keyup",e.boundKeyup,!1),e.removeEventListener("input",e.boundInput,!1),delete e.boundKeydown,delete e.boundKeyup,delete e.boundInput}},{key:"keydown",value:function(t,n){t.shouldDeactivate(n)&&(t.tribute.isActive=!1,t.tribute.hideMenu());var i=this;t.commandEvent=!1,r.keys().forEach(function(e){e.key===n.keyCode&&(t.commandEvent=!0,t.callbacks()[e.value.toLowerCase()](n,i))})}},{key:"input",value:function(e,t){e.inputEvent=!0,e.keyup.call(this,e,t)}},{key:"click",value:function(e,t){var n=e.tribute;if(n.menu&&n.menu.contains(t.target)){var i=t.target;for(t.preventDefault(),t.stopPropagation();"div"!==i.nodeName.toLowerCase();)if(!(i=i.parentNode)||i===n.menu)throw new Error("cannot find the <li> container for the click");n.selectItemAtIndex(i.getAttribute("data-index"),t),n.hideMenu()}else n.current.element&&!n.current.externalTrigger&&(n.current.externalTrigger=!1,setTimeout(function(){return n.hideMenu()}))}},{key:"keyup",value:function(e,t){if(e.inputEvent&&(e.inputEvent=!1),e.updateSelection(this),27!==t.keyCode){if(!e.tribute.allowSpaces&&e.tribute.hasTrailingSpace)return e.tribute.hasTrailingSpace=!1,e.commandEvent=!0,void e.callbacks().space(t,this);if(!e.tribute.isActive)if(e.tribute.autocompleteMode)e.callbacks().triggerChar(t,this,"");else{var n=e.getKeyCode(e,this,t);if(isNaN(n)||!n)return;var i=e.tribute.triggers().find(function(e){return e.charCodeAt(0)===n});void 0!==i&&e.callbacks().triggerChar(t,this,i)}e.tribute.current.mentionText.length<e.tribute.current.collection.menuShowMinLength||((e.tribute.current.trigger||e.tribute.autocompleteMode)&&!1===e.commandEvent||e.tribute.isActive&&8===t.keyCode)&&e.tribute.showMenuFor(this,!0)}}},{key:"shouldDeactivate",value:function(t){if(!this.tribute.isActive)return!1;if(0!==this.tribute.current.mentionText.length)return!1;var n=!1;return r.keys().forEach(function(e){t.keyCode===e.key&&(n=!0)}),!n}},{key:"getKeyCode",value:function(e,t,n){e=e.tribute,e=e.range.getTriggerInfo(!1,e.hasTrailingSpace,!0,e.allowSpaces,e.autocompleteMode);return!!e&&e.mentionTriggerChar.charCodeAt(0)}},{key:"updateSelection",value:function(e){this.tribute.current.element=e;e=this.tribute.range.getTriggerInfo(!1,this.tribute.hasTrailingSpace,!0,this.tribute.allowSpaces,this.tribute.autocompleteMode);e&&(this.tribute.current.selectedPath=e.mentionSelectedPath,this.tribute.current.mentionText=e.mentionText,this.tribute.current.selectedOffset=e.mentionSelectedOffset)}},{key:"callbacks",value:function(){var o=this;return{triggerChar:function(e,t,n){var i=o.tribute;i.current.trigger=n;var r=i.collection.find(function(e){return e.trigger===n});i.current.collection=r,i.current.mentionText.length>=i.current.collection.menuShowMinLength&&i.inputEvent&&i.showMenuFor(t,!0)},enter:function(e,t){o.tribute.isActive&&o.tribute.current.filteredItems&&(e.preventDefault(),e.stopPropagation(),setTimeout(function(){o.tribute.selectItemAtIndex(o.tribute.menuSelected,e),o.tribute.hideMenu()},0))},escape:function(e,t){o.tribute.isActive&&(e.preventDefault(),e.stopPropagation(),o.tribute.isActive=!1,o.tribute.hideMenu())},tab:function(e,t){o.callbacks().enter(e,t)},space:function(e,t){o.tribute.isActive&&(o.tribute.spaceSelectsMatch?o.callbacks().enter(e,t):o.tribute.allowSpaces||(e.stopPropagation(),setTimeout(function(){o.tribute.hideMenu(),o.tribute.isActive=!1},0)))},up:function(e,t){var n;o.tribute.isActive&&o.tribute.current.filteredItems&&(e.preventDefault(),e.stopPropagation(),n=o.tribute.current.filteredItems.length,(e=o.tribute.menuSelected)<n&&0<e?(o.tribute.menuSelected--,o.setActiveLi()):0===e&&(o.tribute.menuSelected=n-1,o.setActiveLi(),o.tribute.menu.scrollTop=o.tribute.menu.scrollHeight))},down:function(e,t){var n;o.tribute.isActive&&o.tribute.current.filteredItems&&(e.preventDefault(),e.stopPropagation(),n=o.tribute.current.filteredItems.length-1,(e=o.tribute.menuSelected)<n?(o.tribute.menuSelected++,o.setActiveLi()):n===e&&(o.tribute.menuSelected=0,o.setActiveLi(),o.tribute.menu.scrollTop=0))},delete:function(e,t){o.tribute.isActive&&o.tribute.current.mentionText.length<1?o.tribute.hideMenu():o.tribute.isActive&&o.tribute.showMenuFor(t)}}}},{key:"setActiveLi",value:function(e){var t=this.tribute.menu.querySelectorAll(".o-mention"),n=t.length>>>0;e&&(this.tribute.menuSelected=parseInt(e));for(var i=0;i<n;i++){var r,o,u,l=t[i];i===this.tribute.menuSelected?(l.classList.add(this.tribute.current.collection.selectClass),u=l.getBoundingClientRect(),r=this.tribute.menu.getBoundingClientRect(),u.bottom>r.bottom?(o=u.bottom-r.bottom,this.tribute.menu.scrollTop+=o):u.top<r.top&&(u=r.top-u.top,this.tribute.menu.scrollTop-=u)):l.classList.remove(this.tribute.current.collection.selectClass)}}},{key:"getFullHeight",value:function(e,t){var n=e.getBoundingClientRect().height;if(t){e=e.currentStyle||window.getComputedStyle(e);return n+parseFloat(e.marginTop)+parseFloat(e.marginBottom)}return n}}],[{key:"keys",value:function(){return[{key:9,value:"TAB"},{key:8,value:"DELETE"},{key:13,value:"ENTER"},{key:27,value:"ESCAPE"},{key:32,value:"SPACE"},{key:38,value:"UP"},{key:40,value:"DOWN"}]}}]),r}(),I=function(){function t(e){A(this,t),this.tribute=e,(this.tribute.menuEvents=this).menu=this.tribute.menu}return e(t,[{key:"bind",value:function(e){var t=this;this.menuClickEvent=this.tribute.events.click.bind(null,this),this.menuContainerScrollEvent=this.debounce(function(){t.tribute.isActive&&t.tribute.showMenuFor(t.tribute.current.element,!1)},300,!1),this.windowResizeEvent=this.debounce(function(){t.tribute.isActive&&t.tribute.range.positionMenuAtCaret(!0)},300,!1),this.tribute.range.getDocument().addEventListener("MSPointerDown",this.menuClickEvent,!1),this.tribute.range.getDocument().addEventListener("mousedown",this.menuClickEvent,!1),window.addEventListener("resize",this.windowResizeEvent),this.menuContainer?this.menuContainer.addEventListener("scroll",this.menuContainerScrollEvent,!1):window.addEventListener("scroll",this.menuContainerScrollEvent)}},{key:"unbind",value:function(e){this.tribute.range.getDocument().removeEventListener("mousedown",this.menuClickEvent,!1),this.tribute.range.getDocument().removeEventListener("MSPointerDown",this.menuClickEvent,!1),window.removeEventListener("resize",this.windowResizeEvent),this.menuContainer?this.menuContainer.removeEventListener("scroll",this.menuContainerScrollEvent,!1):window.removeEventListener("scroll",this.menuContainerScrollEvent)}},{key:"debounce",value:function(i,r,o){var u,l=arguments,s=this;return function(){var e=s,t=l,n=o&&!u;clearTimeout(u),u=setTimeout(function(){u=null,o||i.apply(e,t)},r),n&&i.apply(e,t)}}}]),t}(),N=function(){function t(e){A(this,t),this.tribute=e,this.tribute.range=this}return e(t,[{key:"getDocument",value:function(){var e;return(e=this.tribute.current.collection?this.tribute.current.collection.iframe:e)?e.contentWindow.document:document}},{key:"positionMenuAtCaret",value:function(i){var r,o=this,e=this.tribute.current,t=this.getTriggerInfo(!1,this.tribute.hasTrailingSpace,!0,this.tribute.allowSpaces,this.tribute.autocompleteMode);void 0!==t?this.tribute.positionMenu?(r=this.isContentEditable(e.element)?this.getContentEditableCaretPosition(t.mentionPosition):this.getTextAreaOrInputUnderlinePosition(this.tribute.current.element,t.mentionPosition),this.tribute.menu.style.cssText="top: ".concat(r.top,"px;\n                                     left: ").concat(r.left,"px;\n                                     right: ").concat(r.right,"px;\n                                     bottom: ").concat(r.bottom,"px;\n                                     position: absolute;\n                                     display: block;"),"auto"===r.left&&(this.tribute.menu.style.left="auto"),"auto"===r.top&&(this.tribute.menu.style.top="auto"),i&&this.scrollIntoView(),window.setTimeout(function(){var e={width:o.tribute.menu.offsetWidth,height:o.tribute.menu.offsetHeight},t=o.isMenuOffScreen(r,e),n=window.innerWidth>e.width&&(t.left||t.right),t=window.innerHeight>e.height&&(t.top||t.bottom);(n||t)&&(o.tribute.menu.style.cssText="display: none",o.positionMenuAtCaret(i))},0)):this.tribute.menu.style.cssText="display: block;":this.tribute.menu.style.cssText="display: none"}},{key:"selectElement",value:function(e,t,n){var i=e;if(t)for(var r=0;r<t.length;r++){if(void 0===(i=i.childNodes[t[r]]))return;for(;i.length<n;)n-=i.length,i=i.nextSibling;0!==i.childNodes.length||i.length||(i=i.previousSibling)}var o,u=this.getWindowSelection();(o=this.getDocument().createRange()).setStart(i,n),o.setEnd(i,n),o.collapse(!0);try{u.removeAllRanges()}catch(e){}u.addRange(o),e.focus()}},{key:"replaceTriggerText",value:function(e,t,n,i,r){var o,u,n=this.getTriggerInfo(!0,n,t,this.tribute.allowSpaces,this.tribute.autocompleteMode);void 0!==n&&(t=this.tribute.current,r=new CustomEvent("tribute-replaced",{detail:{item:r,instance:t,context:n,event:i}}),this.isContentEditable(t.element)?(u="string"==typeof this.tribute.replaceTextSuffix?this.tribute.replaceTextSuffix:" ",o=n.mentionPosition+n.mentionText.length,this.tribute.autocompleteMode||(o+=n.mentionTriggerChar.length),this.pasteHtml(e+=u,n.mentionPosition,o)):(i=this.tribute.current.element,e+=u="string"==typeof this.tribute.replaceTextSuffix?this.tribute.replaceTextSuffix:" ",o=n.mentionPosition,u=n.mentionPosition+n.mentionText.length+u.length,this.tribute.autocompleteMode||(u+=n.mentionTriggerChar.length-1),i.value=i.value.substring(0,o)+e+i.value.substring(u,i.value.length),i.selectionStart=o+e.length,i.selectionEnd=o+e.length),t.element.dispatchEvent(new CustomEvent("input",{bubbles:!0})),t.element.dispatchEvent(r))}},{key:"pasteHtml",value:function(e,t,n){var i=this.getWindowSelection(),r=this.getDocument().createRange();r.setStart(i.anchorNode,t),r.setEnd(i.anchorNode,n),r.deleteContents();var o=this.getDocument().createElement("div");o.innerHTML=e;for(var u,l,s=this.getDocument().createDocumentFragment();u=o.firstChild;)l=s.appendChild(u);r.insertNode(s),l&&((r=r.cloneRange()).setStartAfter(l),r.collapse(!0),i.removeAllRanges(),i.addRange(r))}},{key:"getWindowSelection",value:function(){return(this.tribute.collection.iframe?this.tribute.collection.iframe.contentWindow:window).getSelection()}},{key:"getNodePositionInParent",value:function(e){if(null===e.parentNode)return 0;for(var t=0;t<e.parentNode.childNodes.length;t++)if(e.parentNode.childNodes[t]===e)return t}},{key:"getContentEditableSelectedPath",value:function(e){var t=this.getWindowSelection(),n=t.anchorNode,i=[];if(null!=n){for(var r,o=n.contentEditable;null!==n&&"true"!==o;)r=this.getNodePositionInParent(n),i.push(r),null!==(n=n.parentNode)&&(o=n.contentEditable);return i.reverse(),{selected:n,path:i,offset:t.getRangeAt(0).startOffset}}}},{key:"getTextPrecedingCurrentSelection",value:function(){var e,t,n=this.tribute.current,i="";return this.isContentEditable(n.element)?null!=(n=this.getWindowSelection().anchorNode)&&(e=n.textContent,t=this.getWindowSelection().getRangeAt(0).startOffset,e&&0<=t&&(i=e.substring(0,t))):(e=this.tribute.current.element)&&(t=e.selectionStart,e.value&&0<=t&&(i=e.value.substring(0,t))),i}},{key:"getLastWordInText",value:function(e){return e=e.replace(/\u00A0/g," "),(e=this.tribute.autocompleteSeparator?e.split(this.tribute.autocompleteSeparator):e.split(/\s+/))[e.length-1].trim()}},{key:"getTriggerInfo",value:function(e,t,i,n,r){var o,u,l,s=this,a=this.tribute.current;this.isContentEditable(a.element)?(h=this.getContentEditableSelectedPath(a))&&(o=h.selected,u=h.path,l=h.offset):o=this.tribute.current.element;var c=this.getTextPrecedingCurrentSelection(),h=this.getLastWordInText(c);if(r)return{mentionPosition:c.length-h.length,mentionText:h,mentionSelectedElement:o,mentionSelectedPath:u,mentionSelectedOffset:l};if(null!=c){var d=-1;if(this.tribute.collection.forEach(function(e){var t=e.trigger,n=e.requireLeadingSpace?s.lastIndexWithLeadingSpace(c,t):c.lastIndexOf(t);d<n&&(d=n,f=t,i=e.requireLeadingSpace)}),0<=d&&(0===d||!i||/[\xA0\s]/g.test(c.substring(d-1,d)))){var r=c.substring(d+f.length,c.length),f=c.substring(d,d+f.length),h=r.substring(0,1),h=0<r.length&&(" "===h||" "===h);t&&(r=r.trim());n=n?/[^\S ]/g:/[\xA0\s]/g;if(this.tribute.hasTrailingSpace=n.test(r),!h&&(e||!n.test(r)))return{mentionPosition:d,mentionText:r,mentionSelectedElement:o,mentionSelectedPath:u,mentionSelectedOffset:l,mentionTriggerChar:f}}}}},{key:"lastIndexWithLeadingSpace",value:function(e,t){for(var n=e.split("").reverse().join(""),i=-1,r=0,o=e.length;r<o;r++){for(var u=r===e.length-1,l=/\s/.test(n[r+1]),s=!0,a=t.length-1;0<=a;a--)if(t[a]!==n[r-a]){s=!1;break}if(s&&(u||l)){i=e.length-1-r;break}}return i}},{key:"isContentEditable",value:function(e){return"INPUT"!==e.nodeName&&"TEXTAREA"!==e.nodeName}},{key:"isMenuOffScreen",value:function(e,t){var n=window.innerWidth,i=window.innerHeight,r=document.documentElement,o=(window.pageXOffset||r.scrollLeft)-(r.clientLeft||0),u=(window.pageYOffset||r.scrollTop)-(r.clientTop||0),l="number"==typeof e.top?e.top:u+i-e.bottom-t.height,s="number"==typeof e.right?e.right:e.left+t.width,r="number"==typeof e.bottom?e.bottom:e.top+t.height,t="number"==typeof e.left?e.left:o+n-e.right-t.width;return{top:l<Math.floor(u),right:s>Math.ceil(o+n),bottom:r>Math.ceil(u+i),left:t<Math.floor(o)}}},{key:"getMenuDimensions",value:function(){var e={width:null,height:null};return this.tribute.menu.style.cssText="top: 0px;\n                                 left: 0px;\n                                 position: fixed;\n                                 display: block;\n                                 visibility; hidden;",e.width=this.tribute.menu.offsetWidth,e.height=this.tribute.menu.offsetHeight,this.tribute.menu.style.cssText="display: none;",e}},{key:"getTextAreaOrInputUnderlinePosition",value:function(e,t,n){var i=null!==window.mozInnerScreenX,r=this.getDocument().createElement("div");r.id="input-textarea-caret-position-mirror-div",this.getDocument().body.appendChild(r);var o=r.style,u=window.getComputedStyle?getComputedStyle(e):e.currentStyle;o.whiteSpace="pre-wrap","INPUT"!==e.nodeName&&(o.wordWrap="break-word"),o.position="absolute",o.visibility="hidden",["direction","boxSizing","width","height","overflowX","overflowY","borderTopWidth","borderRightWidth","borderBottomWidth","borderLeftWidth","paddingTop","paddingRight","paddingBottom","paddingLeft","fontStyle","fontVariant","fontWeight","fontStretch","fontSize","fontSizeAdjust","lineHeight","fontFamily","textAlign","textTransform","textIndent","textDecoration","letterSpacing","wordSpacing"].forEach(function(e){o[e]=u[e]}),i?(o.width="".concat(parseInt(u.width)-2,"px"),e.scrollHeight>parseInt(u.height)&&(o.overflowY="scroll")):o.overflow="hidden",r.textContent=e.value.substring(0,t),"INPUT"===e.nodeName&&(r.textContent=r.textContent.replace(/\s/g," "));var l=this.getDocument().createElement("span");l.textContent=e.value.substring(t)||".",r.appendChild(l);var s=e.getBoundingClientRect(),a=document.documentElement,c=(window.pageXOffset||a.scrollLeft)-(a.clientLeft||0),h=(window.pageYOffset||a.scrollTop)-(a.clientTop||0),d=0,f=0;this.menuContainerIsBody&&(d=s.top,f=s.left);i={top:d+h+l.offsetTop+parseInt(u.borderTopWidth)+parseInt(u.fontSize)-e.scrollTop,left:f+c+l.offsetLeft+parseInt(u.borderLeftWidth)},t=window.innerWidth,a=window.innerHeight,d=this.getMenuDimensions(),e=this.isMenuOffScreen(i,d);e.right&&(i.right=t-i.left,i.left="auto");f=(this.tribute.menuContainer||this.getDocument().body).offsetHeight;return e.bottom&&(f=f-(a-(this.tribute.menuContainer||this.getDocument().body).getBoundingClientRect().top),i.bottom=f+(a-s.top-l.offsetTop),i.top="auto"),(e=this.isMenuOffScreen(i,d)).left&&(i.left=t>d.width?c+t-d.width:c,delete i.right),e.top&&(i.top=a>d.height?h+a-d.height:h,delete i.bottom),this.getDocument().body.removeChild(r),i}},{key:"getContentEditableCaretPosition",value:function(e){var t=this.getWindowSelection(),n=this.getDocument().createRange();n.setStart(t.anchorNode,e),n.setEnd(t.anchorNode,e),n.collapse(!1);var i=n.getBoundingClientRect(),r=document.documentElement,o=(window.pageXOffset||r.scrollLeft)-(r.clientLeft||0),u=(window.pageYOffset||r.scrollTop)-(r.clientTop||0),l={left:i.left+o,top:i.top+i.height+u},s=window.innerWidth,t=window.innerHeight,e=this.getMenuDimensions(),n=this.isMenuOffScreen(l,e);n.right&&(l.left="auto",l.right=s-i.left-o);r=(this.tribute.menuContainer||this.getDocument().body).offsetHeight;return n.bottom&&(r=r-(t-(this.tribute.menuContainer||this.getDocument().body).getBoundingClientRect().top),l.top="auto",l.bottom=r+(t-i.top)),(n=this.isMenuOffScreen(l,e)).left&&(l.left=s>e.width?o+s-e.width:o,delete l.right),n.top&&(l.top=t>e.height?u+t-e.height:u,delete l.bottom),this.menuContainerIsBody||(l.left=l.left&&l.left-this.tribute.menuContainer.offsetLeft,l.top=l.top&&l.top-this.tribute.menuContainer.offsetTop),l}},{key:"scrollIntoView",value:function(e){var t,n=this.menu;if(void 0!==n){for(;void 0===t||0===t.height;)if(0===(t=n.getBoundingClientRect()).height&&(void 0===(n=n.childNodes[0])||!n.getBoundingClientRect))return;var i=t.top,r=i+t.height;i<0?window.scrollTo(0,window.pageYOffset+t.top-20):r>window.innerHeight&&((i=100<(i=window.pageYOffset+t.top-20)-window.pageYOffset?window.pageYOffset+100:i)<(r=window.pageYOffset-(window.innerHeight-r))&&(r=i),window.scrollTo(0,r))}}},{key:"menuContainerIsBody",get:function(){return this.tribute.menuContainer===document.body||!this.tribute.menuContainer}}]),t}(),D=function(){function t(e){A(this,t),this.tribute=e,this.tribute.search=this}return e(t,[{key:"simpleFilter",value:function(t,e){var n=this;return e.filter(function(e){return n.test(t,e)})}},{key:"test",value:function(e,t){return null!==this.match(e,t)}},{key:"match",value:function(e,t,n){t.length;var i=(n=n||{}).pre||"",r=n.post||"",o=n.caseSensitive&&t||t.toLowerCase();if(n.skip)return{rendered:t,score:0};e=n.caseSensitive&&e||e.toLowerCase();e=this.traverse(o,e,0,0,[]);return e?{rendered:this.render(t,e.cache,i,r),score:e.score}:null}},{key:"traverse",value:function(e,t,n,i,r){if((t=this.tribute.autocompleteSeparator?t.split(this.tribute.autocompleteSeparator).splice(-1)[0]:t).length===i)return{score:this.calculateScore(r),cache:r.slice()};if(!(e.length===n||t.length-i>e.length-n)){for(var o,u,l=t[i],s=e.indexOf(l,n);-1<s;){if(r.push(s),u=this.traverse(e,t,s+1,i+1,r),r.pop(),!u)return o;(!o||o.score<u.score)&&(o=u),s=e.indexOf(l,s+1)}return o}}},{key:"calculateScore",value:function(n){var i=0,r=1;return n.forEach(function(e,t){0<t&&(n[t-1]+1===e?r+=r+1:r=1),i+=r}),i}},{key:"render",value:function(n,i,r,o){var u=n.substring(0,i[0]);return i.forEach(function(e,t){u+=r+n[e]+o+n.substring(e+1,i[t+1]||n.length)}),u}},{key:"filter",value:function(o,e,u){var l=this;return u=u||{},e.reduce(function(e,t,n,i){var r=t;u.extract&&(r=(r=u.extract(t))||"");r=l.match(o,r,u);return null!=r&&(e[e.length]={string:r.rendered,score:r.score,index:n,original:t}),e},[]).sort(function(e,t){var n=t.score-e.score;return n||e.index-t.index})}}]),t}();return function(){function M(e){var n=this,t=e.values,i=void 0===t?null:t,r=e.loadingItemTemplate,o=void 0===r?null:r,u=e.iframe,l=void 0===u?null:u,s=e.selectClass,a=void 0===s?"is-highlight":s,c=e.containerClass,h=void 0===c?"tribute-container":c,d=e.itemClass,f=void 0===d?"":d,m=e.trigger,p=void 0===m?"@":m,g=e.autocompleteMode,v=void 0!==g&&g,b=e.autocompleteSeparator,y=void 0===b?null:b,w=e.selectTemplate,t=void 0===w?null:w,r=e.menuItemTemplate,u=void 0===r?null:r,s=e.lookup,T=void 0===s?"key":s,c=e.fillAttr,S=void 0===c?"value":c,d=e.collection,m=void 0===d?null:d,g=e.menuContainer,b=void 0===g?null:g,w=e.noMatchTemplate,C=void 0===w?null:w,r=e.requireLeadingSpace,s=void 0===r||r,c=e.allowSpaces,d=void 0!==c&&c,g=e.replaceTextSuffix,w=void 0===g?null:g,r=e.positionMenu,c=void 0===r||r,g=e.spaceSelectsMatch,r=void 0!==g&&g,g=e.searchOpts,E=void 0===g?{}:g,g=e.menuItemLimit,k=void 0===g?null:g,e=e.menuShowMinLength,x=void 0===e?0:e;if(A(this,M),this.autocompleteMode=v,this.autocompleteSeparator=y,this.menuSelected=0,this.current={},this.inputEvent=!1,this.isActive=!1,this.menuContainer=b,this.allowSpaces=d,this.replaceTextSuffix=w,this.positionMenu=c,this.hasTrailingSpace=!1,this.spaceSelectsMatch=r,this.autocompleteMode&&(p=""),i)this.collection=[{trigger:p,iframe:l,selectClass:a,containerClass:h,itemClass:f,selectTemplate:(t||M.defaultSelectTemplate).bind(this),menuItemTemplate:(u||M.defaultMenuItemTemplate).bind(this),noMatchTemplate:"string"==typeof(u=C)?""===u.trim()?null:u:"function"==typeof u?u.bind(n):C||function(){return"<li>No Match Found!</li>"}.bind(n),lookup:T,fillAttr:S,values:i,loadingItemTemplate:o,requireLeadingSpace:s,searchOpts:E,menuItemLimit:k,menuShowMinLength:x}];else{if(!m)throw new Error("[Tribute] No collection specified.");this.autocompleteMode&&console.warn("Tribute in autocomplete mode does not work for collections"),this.collection=m.map(function(e){return{trigger:e.trigger||p,iframe:e.iframe||l,selectClass:e.selectClass||a,containerClass:e.containerClass||h,itemClass:e.itemClass||f,selectTemplate:(e.selectTemplate||M.defaultSelectTemplate).bind(n),menuItemTemplate:(e.menuItemTemplate||M.defaultMenuItemTemplate).bind(n),noMatchTemplate:"string"==typeof(t=C)?""===t.trim()?null:t:"function"==typeof t?t.bind(n):C||function(){return"<li>No Match Found!</li>"}.bind(n),lookup:e.lookup||T,fillAttr:e.fillAttr||S,values:e.values,loadingItemTemplate:e.loadingItemTemplate,requireLeadingSpace:e.requireLeadingSpace,searchOpts:e.searchOpts||E,menuItemLimit:e.menuItemLimit||k,menuShowMinLength:e.menuShowMinLength||x};var t})}new N(this),new L(this),new I(this),new D(this)}return e(M,[{key:"triggers",value:function(){return this.collection.map(function(e){return e.trigger})}},{key:"attach",value:function(e){if(!e)throw new Error("[Tribute] Must pass in a DOM node or NodeList.");if((e="undefined"!=typeof jQuery&&e instanceof jQuery?e.get():e).constructor===NodeList||e.constructor===HTMLCollection||e.constructor===Array)for(var t=e.length,n=0;n<t;++n)this._attach(e[n]);else this._attach(e)}},{key:"_attach",value:function(e){e.hasAttribute("data-tribute")&&console.warn("Tribute was already bound to "+e.nodeName),this.ensureEditable(e),this.events.bind(e),e.setAttribute("data-tribute",!0)}},{key:"ensureEditable",value:function(e){if(-1===M.inputTypes().indexOf(e.nodeName)){if(!e.contentEditable)throw new Error("[Tribute] Cannot bind to "+e.nodeName);e.contentEditable=!0}}},{key:"createMenu",value:function(e){var t=this.range.getDocument().createElement("div"),n=this.range.getDocument().createElement("div");return t.className=e,t.appendChild(n),(this.menuContainer||this.range.getDocument().body).appendChild(t)}},{key:"showMenuFor",value:function(e,r){var o=this;this.isActive&&this.current.element===e&&this.current.mentionText===this.currentMentionTextSnapshot||(this.currentMentionTextSnapshot=this.current.mentionText,this.menu||(this.menu=this.createMenu(this.current.collection.containerClass),e.tributeMenu=this.menu,this.menuEvents.bind(this.menu)),this.isActive=!0,this.menuSelected=0,this.current.mentionText||(this.current.mentionText=""),e=function(e){if(o.isActive){var t=o.search.filter(o.current.mentionText,e,{pre:o.current.collection.searchOpts.pre||"<span>",post:o.current.collection.searchOpts.post||"</span>",skip:o.current.collection.searchOpts.skip,extract:function(e){if("string"==typeof o.current.collection.lookup)return e[o.current.collection.lookup];if("function"==typeof o.current.collection.lookup)return o.current.collection.lookup(e,o.current.mentionText);throw new Error("Invalid lookup attribute, lookup must be string or function.")}});o.current.collection.menuItemLimit&&(t=t.slice(0,o.current.collection.menuItemLimit)),o.current.filteredItems=t;var n=o.menu.querySelector("div");if(o.range.positionMenuAtCaret(r),!t.length){e=new CustomEvent("tribute-no-match",{detail:o.menu});return o.current.element.dispatchEvent(e),void("function"==typeof o.current.collection.noMatchTemplate&&!o.current.collection.noMatchTemplate()||!o.current.collection.noMatchTemplate?o.hideMenu():"function"==typeof o.current.collection.noMatchTemplate?n.innerHTML=o.current.collection.noMatchTemplate():n.innerHTML=o.current.collection.noMatchTemplate)}n.innerHTML="";var i=o.range.getDocument().createDocumentFragment();t.forEach(function(e,t){var n=o.range.getDocument().createElement("div");n.setAttribute("data-index",t),n.className=o.current.collection.itemClass+" o-mention",n.addEventListener("mousemove",function(e){var t=u(o._findLiTarget(e.target),2),t=(t[0],t[1]);0!==e.movementY&&o.events.setActiveLi(t)}),o.menuSelected===t&&n.classList.add(o.current.collection.selectClass),n.innerHTML=o.current.collection.menuItemTemplate(e),i.appendChild(n)}),n.appendChild(i)}},"function"==typeof this.current.collection.values?(this.current.collection.loadingItemTemplate&&(this.menu.querySelector("ul").innerHTML=this.current.collection.loadingItemTemplate,this.range.positionMenuAtCaret(r)),this.current.collection.values(this.current.mentionText,e)):e(this.current.collection.values))}},{key:"_findLiTarget",value:function(e){if(!e)return[];var t=e.getAttribute("data-index");return t?[e,t]:this._findLiTarget(e.parentNode)}},{key:"showMenuForCollection",value:function(e,t){e!==document.activeElement&&this.placeCaretAtEnd(e),this.current.collection=this.collection[t||0],this.current.externalTrigger=!0,(this.current.element=e).isContentEditable?this.insertTextAtCursor(this.current.collection.trigger):this.insertAtCaret(e,this.current.collection.trigger),this.showMenuFor(e)}},{key:"placeCaretAtEnd",value:function(e){var t,n;e.focus(),void 0!==window.getSelection&&void 0!==document.createRange?((n=document.createRange()).selectNodeContents(e),n.collapse(!1),(t=window.getSelection()).removeAllRanges(),t.addRange(n)):void 0!==document.body.createTextRange&&((n=document.body.createTextRange()).moveToElementText(e),n.collapse(!1),n.select())}},{key:"insertTextAtCursor",value:function(e){var t=window.getSelection(),n=t.getRangeAt(0);n.deleteContents();e=document.createTextNode(e);n.insertNode(e),n.selectNodeContents(e),n.collapse(!1),t.removeAllRanges(),t.addRange(n)}},{key:"insertAtCaret",value:function(e,t){var n=e.scrollTop,i=e.selectionStart,r=e.value.substring(0,i),o=e.value.substring(e.selectionEnd,e.value.length);e.value=r+t+o,i+=t.length,e.selectionStart=i,e.selectionEnd=i,e.focus(),e.scrollTop=n}},{key:"hideMenu",value:function(){this.menu&&(this.menu.style.cssText="display: none;",this.isActive=!1,this.menuSelected=0,this.current={})}},{key:"selectItemAtIndex",value:function(e,t){var n;"number"!=typeof(e=parseInt(e))||isNaN(e)||(n=this.current.filteredItems[e],null!==(e=this.current.collection.selectTemplate(n))&&this.replaceText(e,t,n))}},{key:"replaceText",value:function(e,t,n){this.range.replaceTriggerText(e,!0,!0,t,n)}},{key:"_append",value:function(e,t,n){if("function"==typeof e.values)throw new Error("Unable to append to values, as it is a function.");e.values=n?t:e.values.concat(t)}},{key:"append",value:function(e,t,n){e=parseInt(e);if("number"!=typeof e)throw new Error("please provide an index for the collection to update.");e=this.collection[e];this._append(e,t,n)}},{key:"appendCurrent",value:function(e,t){if(!this.isActive)throw new Error("No active state. Please use append instead and pass an index.");this._append(this.current.collection,e,t)}},{key:"detach",value:function(e){if(!e)throw new Error("[Tribute] Must pass in a DOM node or NodeList.");if((e="undefined"!=typeof jQuery&&e instanceof jQuery?e.get():e).constructor===NodeList||e.constructor===HTMLCollection||e.constructor===Array)for(var t=e.length,n=0;n<t;++n)this._detach(e[n]);else this._detach(e)}},{key:"_detach",value:function(e){var t=this;this.events.unbind(e),e.tributeMenu&&this.menuEvents.unbind(e.tributeMenu),setTimeout(function(){e.removeAttribute("data-tribute"),t.isActive=!1,e.tributeMenu&&e.tributeMenu.remove()})}},{key:"isActive",get:function(){return this._isActive},set:function(e){this._isActive!=e&&(this._isActive=e,this.current.element&&(e=new CustomEvent("tribute-active-".concat(e)),this.current.element.dispatchEvent(e)))}}],[{key:"defaultSelectTemplate",value:function(e){return void 0===e?"".concat(this.current.collection.trigger).concat(this.current.mentionText):this.range.isContentEditable(this.current.element)?'<span class="tribute-mention">'+(this.current.collection.trigger+e.original[this.current.collection.fillAttr])+"</span>":this.current.collection.trigger+e.original[this.current.collection.fillAttr]}},{key:"defaultMenuItemTemplate",value:function(e){return e.string}},{key:"inputTypes",value:function(){return["TEXTAREA","INPUT"]}}]),M}()},"object"==typeof exports&&void 0!==n?n.exports=t():"function"==typeof define&&define.amd?define(t):(e=e||self).Tribute=t(),n.resolve()})});