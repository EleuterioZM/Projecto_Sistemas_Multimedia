(function(f){typeof exports=="object"&&typeof module=="object"?f(require("../../lib/codemirror"),require("./foldcode")):typeof define=="function"&&define.amd?define(["../../lib/codemirror","./foldcode"],f):f(CodeMirror)})(function(f){"use strict";f.defineOption("foldGutter",!1,function(t,e,r){r&&r!=f.Init&&(t.clearGutter(t.state.foldGutter.options.gutter),t.state.foldGutter=null,t.off("gutterClick",G),t.off("changes",a),t.off("viewportChange",w),t.off("fold",l),t.off("unfold",l),t.off("swapDoc",a),t.off("optionChange",F)),e&&(t.state.foldGutter=new M(b(e)),g(t),t.on("gutterClick",G),t.on("changes",a),t.on("viewportChange",w),t.on("fold",l),t.on("unfold",l),t.on("swapDoc",a),t.on("optionChange",F))});var u=f.Pos;function M(t){this.options=t,this.from=this.to=0}function b(t){return t===!0&&(t={}),t.gutter==null&&(t.gutter="CodeMirror-foldgutter"),t.indicatorOpen==null&&(t.indicatorOpen="CodeMirror-foldgutter-open"),t.indicatorFolded==null&&(t.indicatorFolded="CodeMirror-foldgutter-folded"),t}function c(t,e){for(var r=t.findMarks(u(e,0),u(e+1,0)),o=0;o<r.length;++o)if(r[o].__isFold){var n=r[o].find(-1);if(n&&n.line===e)return r[o]}}function h(t){if(typeof t=="string"){var e=document.createElement("div");return e.className=t+" CodeMirror-guttermarker-subtle",e}else return t.cloneNode(!0)}function d(t,e,r){var o=t.state.foldGutter.options,n=e-1,s=t.foldOption(o,"minFoldSize"),O=t.foldOption(o,"rangeFinder"),k=typeof o.indicatorFolded=="string"&&C(o.indicatorFolded),T=typeof o.indicatorOpen=="string"&&C(o.indicatorOpen);t.eachLine(e,r,function(y){++n;var p=null,i=y.gutterMarkers;if(i&&(i=i[o.gutter]),c(t,n)){if(k&&i&&k.test(i.className))return;p=h(o.indicatorFolded)}else{var S=u(n,0),v=O&&O(t,S);if(v&&v.to.line-v.from.line>=s){if(T&&i&&T.test(i.className))return;p=h(o.indicatorOpen)}}!p&&!i||t.setGutterMarker(y,o.gutter,p)})}function C(t){return new RegExp("(^|\\s)"+t+"(?:$|\\s)\\s*")}function g(t){var e=t.getViewport(),r=t.state.foldGutter;r&&(t.operation(function(){d(t,e.from,e.to)}),r.from=e.from,r.to=e.to)}function G(t,e,r){var o=t.state.foldGutter;if(o){var n=o.options;if(r==n.gutter){var s=c(t,e);s?s.clear():t.foldCode(u(e,0),n)}}}function F(t,e){e=="mode"&&a(t)}function a(t){var e=t.state.foldGutter;if(e){var r=e.options;e.from=e.to=0,clearTimeout(e.changeUpdate),e.changeUpdate=setTimeout(function(){g(t)},r.foldOnChangeTimeSpan||600)}}function w(t){var e=t.state.foldGutter;if(e){var r=e.options;clearTimeout(e.changeUpdate),e.changeUpdate=setTimeout(function(){var o=t.getViewport();e.from==e.to||o.from-e.to>20||e.from-o.to>20?g(t):t.operation(function(){o.from<e.from&&(d(t,o.from,e.from),e.from=o.from),o.to>e.to&&(d(t,e.to,o.to),e.to=o.to)})},r.updateViewportTimeSpan||400)}}function l(t,e){var r=t.state.foldGutter;if(r){var o=e.line;o>=r.from&&o<r.to&&d(t,o,o+1)}}});
