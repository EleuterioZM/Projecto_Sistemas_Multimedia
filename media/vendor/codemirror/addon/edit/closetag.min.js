(function(n){typeof exports=="object"&&typeof module=="object"?n(require("../../lib/codemirror"),require("../fold/xml-fold")):typeof define=="function"&&define.amd?define(["../../lib/codemirror","../fold/xml-fold"],n):n(CodeMirror)})(function(n){n.defineOption("autoCloseTags",!1,function(e,r,t){if(t!=n.Init&&t&&e.removeKeyMap("autoCloseTags"),!!r){var a={name:"autoCloseTags"};(typeof r!="object"||r.whenClosing!==!1)&&(a["'/'"]=function(l){return w(l)}),(typeof r!="object"||r.whenOpening!==!1)&&(a["'>'"]=function(l){return m(l)}),e.addKeyMap(a)}});var C=["area","base","br","col","command","embed","hr","img","input","keygen","link","meta","param","source","track","wbr"],j=["applet","blockquote","body","button","div","dl","fieldset","form","frameset","h1","h2","h3","h4","h5","h6","head","html","iframe","layer","legend","object","ol","p","select","table","ul"];function m(e){if(e.getOption("disableInput"))return n.Pass;for(var r=e.listSelections(),t=[],a=e.getOption("autoCloseTags"),l=0;l<r.length;l++){if(!r[l].empty())return n.Pass;var i=r[l].head,f=e.getTokenAt(i),s=n.innerMode(e.getMode(),f.state),o=s.state,d=s.mode.xmlCurrentTag&&s.mode.xmlCurrentTag(o),u=d&&d.name;if(!u)return n.Pass;var y=s.mode.configuration=="html",g=typeof a=="object"&&a.dontCloseTags||y&&C,c=typeof a=="object"&&a.indentTags||y&&j;f.end>i.ch&&(u=u.slice(0,u.length-f.end+i.ch));var h=u.toLowerCase();if(!u||f.type=="string"&&(f.end!=i.ch||!/[\"\']/.test(f.string.charAt(f.string.length-1))||f.string.length==1)||f.type=="tag"&&d.close||f.string.indexOf("/")==i.ch-f.start-1||g&&p(g,h)>-1||O(e,s.mode.xmlCurrentContext&&s.mode.xmlCurrentContext(o)||[],u,i,!0))return n.Pass;var b=typeof a=="object"&&a.emptyTags;if(b&&p(b,u)>-1){t[l]={text:"/>",newPos:n.Pos(i.line,i.ch+2)};continue}var P=c&&p(c,h)>-1;t[l]={indent:P,text:">"+(P?`

`:"")+"</"+u+">",newPos:P?n.Pos(i.line+1,0):n.Pos(i.line,i.ch+1)}}for(var A=typeof a=="object"&&a.dontIndentOnAutoClose,l=r.length-1;l>=0;l--){var v=t[l];e.replaceRange(v.text,r[l].head,r[l].anchor,"+insert");var T=e.listSelections().slice(0);T[l]={head:v.newPos,anchor:v.newPos},e.setSelections(T),!A&&v.indent&&(e.indentLine(v.newPos.line,null,!0),e.indentLine(v.newPos.line+1,null,!0))}}function x(e,r){for(var t=e.listSelections(),a=[],l=r?"/":"</",i=e.getOption("autoCloseTags"),f=typeof i=="object"&&i.dontIndentOnSlash,s=0;s<t.length;s++){if(!t[s].empty())return n.Pass;var o=t[s].head,d=e.getTokenAt(o),u=n.innerMode(e.getMode(),d.state),y=u.state;if(r&&(d.type=="string"||d.string.charAt(0)!="<"||d.start!=o.ch-1))return n.Pass;var g,c=u.mode.name!="xml"&&e.getMode().name=="htmlmixed";if(c&&u.mode.name=="javascript")g=l+"script";else if(c&&u.mode.name=="css")g=l+"style";else{var h=u.mode.xmlCurrentContext&&u.mode.xmlCurrentContext(y),b=h.length?h[h.length-1]:"";if(!h||h.length&&O(e,h,b,o))return n.Pass;g=l+b}e.getLine(o.line).charAt(d.end)!=">"&&(g+=">"),a[s]=g}if(e.replaceSelections(a),t=e.listSelections(),!f)for(var s=0;s<t.length;s++)(s==t.length-1||t[s].head.line<t[s+1].head.line)&&e.indentLine(t[s].head.line)}function w(e){return e.getOption("disableInput")?n.Pass:x(e,!0)}n.commands.closeTag=function(e){return x(e)};function p(e,r){if(e.indexOf)return e.indexOf(r);for(var t=0,a=e.length;t<a;++t)if(e[t]==r)return t;return-1}function O(e,r,t,a,l){if(!n.scanForClosingTag)return!1;var i=Math.min(e.lastLine()+1,a.line+500),f=n.scanForClosingTag(e,a,null,i);if(!f||f.tag!=t)return!1;for(var s=l?1:0,o=r.length-1;o>=0&&r[o]==t;o--)++s;a=f.to;for(var o=1;o<s;o++){var d=n.scanForClosingTag(e,a,null,i);if(!d||d.tag!=t)return!1;a=d.to}return!0}});
