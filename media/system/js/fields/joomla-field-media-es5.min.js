(function(){"use strict";function V(){V=function(){return s};var u,s={},h=Object.prototype,t=h.hasOwnProperty,i=Object.defineProperty||function(r,e,n){r[e]=n.value},d=typeof Symbol=="function"?Symbol:{},m=d.iterator||"@@iterator",o=d.asyncIterator||"@@asyncIterator",l=d.toStringTag||"@@toStringTag";function f(r,e,n){return Object.defineProperty(r,e,{value:n,enumerable:!0,configurable:!0,writable:!0}),r[e]}try{f({},"")}catch{f=function(e,n,c){return e[n]=c}}function E(r,e,n,c){var a=e&&e.prototype instanceof U?e:U,p=Object.create(a.prototype),v=new W(c||[]);return i(p,"_invoke",{value:ot(r,n,v)}),p}function g(r,e,n){try{return{type:"normal",arg:r.call(e,n)}}catch(c){return{type:"throw",arg:c}}}s.wrap=E;var O="suspendedStart",L="suspendedYield",y="executing",k="completed",A={};function U(){}function M(){}function P(){}var G={};f(G,m,function(){return this});var q=Object.getPrototypeOf,x=q&&q(q($([])));x&&x!==h&&t.call(x,m)&&(G=x);var j=P.prototype=U.prototype=Object.create(G);function Y(r){["next","throw","return"].forEach(function(e){f(r,e,function(n){return this._invoke(e,n)})})}function C(r,e){function n(a,p,v,b){var w=g(r[a],r,p);if(w.type!=="throw"){var I=w.arg,J=I.value;return J&&typeof J=="object"&&t.call(J,"__await")?e.resolve(J.__await).then(function(S){n("next",S,v,b)},function(S){n("throw",S,v,b)}):e.resolve(J).then(function(S){I.value=S,v(I)},function(S){return n("throw",S,v,b)})}b(w.arg)}var c;i(this,"_invoke",{value:function(a,p){function v(){return new e(function(b,w){n(a,p,b,w)})}return c=c?c.then(v,v):v()}})}function ot(r,e,n){var c=O;return function(a,p){if(c===y)throw new Error("Generator is already running");if(c===k){if(a==="throw")throw p;return{value:u,done:!0}}for(n.method=a,n.arg=p;;){var v=n.delegate;if(v){var b=K(v,n);if(b){if(b===A)continue;return b}}if(n.method==="next")n.sent=n._sent=n.arg;else if(n.method==="throw"){if(c===O)throw c=k,n.arg;n.dispatchException(n.arg)}else n.method==="return"&&n.abrupt("return",n.arg);c=y;var w=g(r,e,n);if(w.type==="normal"){if(c=n.done?k:L,w.arg===A)continue;return{value:w.arg,done:n.done}}w.type==="throw"&&(c=k,n.method="throw",n.arg=w.arg)}}}function K(r,e){var n=e.method,c=r.iterator[n];if(c===u)return e.delegate=null,n==="throw"&&r.iterator.return&&(e.method="return",e.arg=u,K(r,e),e.method==="throw")||n!=="return"&&(e.method="throw",e.arg=new TypeError("The iterator does not provide a '"+n+"' method")),A;var a=g(c,r.iterator,e.arg);if(a.type==="throw")return e.method="throw",e.arg=a.arg,e.delegate=null,A;var p=a.arg;return p?p.done?(e[r.resultName]=p.value,e.next=r.nextLoc,e.method!=="return"&&(e.method="next",e.arg=u),e.delegate=null,A):p:(e.method="throw",e.arg=new TypeError("iterator result is not an object"),e.delegate=null,A)}function at(r){var e={tryLoc:r[0]};1 in r&&(e.catchLoc=r[1]),2 in r&&(e.finallyLoc=r[2],e.afterLoc=r[3]),this.tryEntries.push(e)}function H(r){var e=r.completion||{};e.type="normal",delete e.arg,r.completion=e}function W(r){this.tryEntries=[{tryLoc:"root"}],r.forEach(at,this),this.reset(!0)}function $(r){if(r||r===""){var e=r[m];if(e)return e.call(r);if(typeof r.next=="function")return r;if(!isNaN(r.length)){var n=-1,c=function a(){for(;++n<r.length;)if(t.call(r,n))return a.value=r[n],a.done=!1,a;return a.value=u,a.done=!0,a};return c.next=c}}throw new TypeError(typeof r+" is not iterable")}return M.prototype=P,i(j,"constructor",{value:P,configurable:!0}),i(P,"constructor",{value:M,configurable:!0}),M.displayName=f(P,l,"GeneratorFunction"),s.isGeneratorFunction=function(r){var e=typeof r=="function"&&r.constructor;return!!e&&(e===M||(e.displayName||e.name)==="GeneratorFunction")},s.mark=function(r){return Object.setPrototypeOf?Object.setPrototypeOf(r,P):(r.__proto__=P,f(r,l,"GeneratorFunction")),r.prototype=Object.create(j),r},s.awrap=function(r){return{__await:r}},Y(C.prototype),f(C.prototype,o,function(){return this}),s.AsyncIterator=C,s.async=function(r,e,n,c,a){a===void 0&&(a=Promise);var p=new C(E(r,e,n,c),a);return s.isGeneratorFunction(e)?p:p.next().then(function(v){return v.done?v.value:p.next()})},Y(j),f(j,l,"Generator"),f(j,m,function(){return this}),f(j,"toString",function(){return"[object Generator]"}),s.keys=function(r){var e=Object(r),n=[];for(var c in e)n.push(c);return n.reverse(),function a(){for(;n.length;){var p=n.pop();if(p in e)return a.value=p,a.done=!1,a}return a.done=!0,a}},s.values=$,W.prototype={constructor:W,reset:function(r){if(this.prev=0,this.next=0,this.sent=this._sent=u,this.done=!1,this.delegate=null,this.method="next",this.arg=u,this.tryEntries.forEach(H),!r)for(var e in this)e.charAt(0)==="t"&&t.call(this,e)&&!isNaN(+e.slice(1))&&(this[e]=u)},stop:function(){this.done=!0;var r=this.tryEntries[0].completion;if(r.type==="throw")throw r.arg;return this.rval},dispatchException:function(r){if(this.done)throw r;var e=this;function n(w,I){return p.type="throw",p.arg=r,e.next=w,I&&(e.method="next",e.arg=u),!!I}for(var c=this.tryEntries.length-1;c>=0;--c){var a=this.tryEntries[c],p=a.completion;if(a.tryLoc==="root")return n("end");if(a.tryLoc<=this.prev){var v=t.call(a,"catchLoc"),b=t.call(a,"finallyLoc");if(v&&b){if(this.prev<a.catchLoc)return n(a.catchLoc,!0);if(this.prev<a.finallyLoc)return n(a.finallyLoc)}else if(v){if(this.prev<a.catchLoc)return n(a.catchLoc,!0)}else{if(!b)throw new Error("try statement without catch or finally");if(this.prev<a.finallyLoc)return n(a.finallyLoc)}}}},abrupt:function(r,e){for(var n=this.tryEntries.length-1;n>=0;--n){var c=this.tryEntries[n];if(c.tryLoc<=this.prev&&t.call(c,"finallyLoc")&&this.prev<c.finallyLoc){var a=c;break}}a&&(r==="break"||r==="continue")&&a.tryLoc<=e&&e<=a.finallyLoc&&(a=null);var p=a?a.completion:{};return p.type=r,p.arg=e,a?(this.method="next",this.next=a.finallyLoc,A):this.complete(p)},complete:function(r,e){if(r.type==="throw")throw r.arg;return r.type==="break"||r.type==="continue"?this.next=r.arg:r.type==="return"?(this.rval=this.arg=r.arg,this.method="return",this.next="end"):r.type==="normal"&&e&&(this.next=e),A},finish:function(r){for(var e=this.tryEntries.length-1;e>=0;--e){var n=this.tryEntries[e];if(n.finallyLoc===r)return this.complete(n.completion,n.afterLoc),H(n),A}},catch:function(r){for(var e=this.tryEntries.length-1;e>=0;--e){var n=this.tryEntries[e];if(n.tryLoc===r){var c=n.completion;if(c.type==="throw"){var a=c.arg;H(n)}return a}}throw new Error("illegal catch attempt")},delegateYield:function(r,e,n){return this.delegate={iterator:$(r),resultName:e,nextLoc:n},this.method==="next"&&(this.arg=u),A}},s}function B(u,s,h,t,i,d,m){try{var o=u[d](m),l=o.value}catch(f){h(f);return}o.done?s(l):Promise.resolve(l).then(t,i)}function D(u){return function(){var s=this,h=arguments;return new Promise(function(t,i){var d=u.apply(s,h);function m(l){B(d,t,i,m,o,"next",l)}function o(l){B(d,t,i,m,o,"throw",l)}m(void 0)})}}function z(u,s){for(var h=0;h<s.length;h++){var t=s[h];t.enumerable=t.enumerable||!1,t.configurable=!0,"value"in t&&(t.writable=!0),Object.defineProperty(u,rt(t.key),t)}}function Q(u,s,h){return s&&z(u.prototype,s),h&&z(u,h),Object.defineProperty(u,"prototype",{writable:!1}),u}function X(u,s){u.prototype=Object.create(s.prototype),u.prototype.constructor=u,T(u,s)}function N(u){return N=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(h){return h.__proto__||Object.getPrototypeOf(h)},N(u)}function T(u,s){return T=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(t,i){return t.__proto__=i,t},T(u,s)}function Z(){if(typeof Reflect>"u"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch{return!1}}function F(u,s,h){return Z()?F=Reflect.construct.bind():F=function(i,d,m){var o=[null];o.push.apply(o,d);var l=Function.bind.apply(i,o),f=new l;return m&&T(f,m.prototype),f},F.apply(null,arguments)}function tt(u){return Function.toString.call(u).indexOf("[native code]")!==-1}function R(u){var s=typeof Map=="function"?new Map:void 0;return R=function(t){if(t===null||!tt(t))return t;if(typeof t!="function")throw new TypeError("Super expression must either be null or a function");if(typeof s<"u"){if(s.has(t))return s.get(t);s.set(t,i)}function i(){return F(t,arguments,N(this).constructor)}return i.prototype=Object.create(t.prototype,{constructor:{value:i,enumerable:!1,writable:!0,configurable:!0}}),T(i,t)},R(u)}function _(u){if(u===void 0)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return u}function et(u,s){if(typeof u!="object"||u===null)return u;var h=u[Symbol.toPrimitive];if(h!==void 0){var t=h.call(u,s||"default");if(typeof t!="object")return t;throw new TypeError("@@toPrimitive must return a primitive value.")}return(s==="string"?String:Number)(u)}function rt(u){var s=et(u,"string");return typeof s=="symbol"?s:String(s)}/**
 * @copyright  (C) 2018 Open Source Matters, Inc. <https://www.joomla.org>
 * @license    GNU General Public License version 2 or later; see LICENSE.txt
 */if(!Joomla)throw new Error("Joomla API is not properly initiated");var nt=function(s){var h=s.split(/[#]/);return h.length>1?h[1].split(/[?]/)[0].split(".").pop().trim():s.split(/[#?]/)[0].split(".").pop().trim()},it=function(u){X(s,u);function s(){var t;return t=u.call(this)||this,t.onSelected=t.onSelected.bind(_(t)),t.show=t.show.bind(_(t)),t.clearValue=t.clearValue.bind(_(t)),t.modalClose=t.modalClose.bind(_(t)),t.setValue=t.setValue.bind(_(t)),t.updatePreview=t.updatePreview.bind(_(t)),t.validateValue=t.validateValue.bind(_(t)),t.markValid=t.markValid.bind(_(t)),t.markInvalid=t.markInvalid.bind(_(t)),t.mimeType="",t}var h=s.prototype;return h.connectedCallback=function(){if(this.button=this.querySelector(this.buttonSelect),this.inputElement=this.querySelector(this.input),this.buttonClearEl=this.querySelector(this.buttonClear),this.modalElement=this.querySelector(".joomla-modal"),this.buttonSaveSelectedElement=this.querySelector(this.buttonSaveSelected),this.previewElement=this.querySelector(".field-media-preview"),!this.button||!this.inputElement||!this.buttonClearEl||!this.modalElement||!this.buttonSaveSelectedElement)throw new Error("Misconfiguaration...");if(this.button.addEventListener("click",this.show),this.modalElement&&window.bootstrap&&window.bootstrap.Modal&&!window.bootstrap.Modal.getInstance(this.modalElement)&&Joomla.initialiseModal(this.modalElement,{isJoomla:!0}),this.buttonClearEl&&this.buttonClearEl.addEventListener("click",this.clearValue),this.supportedExtensions=Joomla.getOptions("media-picker",{}),!Object.keys(this.supportedExtensions).length)throw new Error("Joomla API is not properly initiated");this.inputElement.removeAttribute("readonly"),this.inputElement.addEventListener("change",this.validateValue),this.updatePreview()},h.disconnectedCallback=function(){this.button&&this.button.removeEventListener("click",this.show),this.buttonClearEl&&this.buttonClearEl.removeEventListener("click",this.clearValue),this.inputElement&&this.inputElement.removeEventListener("change",this.validateValue)},h.onSelected=function(i){return i.preventDefault(),i.stopPropagation(),this.modalClose(),!1},h.show=function(){this.modalElement.open(),Joomla.selectedMediaFile={},this.buttonSaveSelectedElement.addEventListener("click",this.onSelected)},h.modalClose=function(){var t=D(V().mark(function d(){return V().wrap(function(o){for(;;)switch(o.prev=o.next){case 0:return o.prev=0,o.next=3,Joomla.getMedia(Joomla.selectedMediaFile,this.inputElement,this);case 3:o.next=8;break;case 5:o.prev=5,o.t0=o.catch(0),Joomla.renderMessages({error:[Joomla.Text._("JLIB_APPLICATION_ERROR_SERVER")]});case 8:Joomla.selectedMediaFile={},Joomla.Modal.getCurrent().close();case 10:case"end":return o.stop()}},d,this,[[0,5]])}));function i(){return t.apply(this,arguments)}return i}(),h.setValue=function(i){this.inputElement.value=i,this.validatedUrl=i,this.mimeType=Joomla.selectedMediaFile.fileType,this.updatePreview(),this.inputElement.dispatchEvent(new Event("change")),this.dispatchEvent(new CustomEvent("change",{detail:{value:i},bubbles:!0}))},h.validateValue=function(){var t=D(V().mark(function d(m){var o=this,l,f,E,g;return V().wrap(function(L){for(;;)switch(L.prev=L.next){case 0:if(l=m.target.value,!(this.validatedUrl===l||l==="")){L.next=3;break}return L.abrupt("return");case 3:if(/^(http(s)?:\/\/).+$/.test(l))try{fetch(l).then(function(y){y.status===200?(o.validatedUrl=l,o.markValid()):(o.validatedUrl=l,o.markInvalid())})}catch{this.validatedUrl=l,this.markInvalid()}else/^\//.test(l)&&(l=l.substring(1)),f=l.split("#"),E=f[0].split("/"),g=E.slice(1),fetch(Joomla.getOptions("system.paths").rootFull+"/"+l).then(function(y){return y.blob()}).then(function(y){if(y.type.includes("image")){var k=new Image;k.src=URL.createObjectURL(y),k.onload=function(){o.inputElement.value=E[0]+"/"+g.join("/")+"#joomlaImage://local-"+E[0]+"/"+g.join("/")+"?width="+k.width+"&height="+k.height,o.validatedUrl=E[0]+"/"+g.join("/")+"#joomlaImage://local-"+E[0]+"/"+g.join("/")+"?width="+k.width+"&height="+k.height,o.markValid()}}else y.type.includes("audio")||y.type.includes("video")||y.type.includes("application/pdf")?(o.mimeType=y.type,o.inputElement.value=l,o.validatedUrl=l,o.markValid()):(o.validatedUrl=l,o.markInvalid())}).catch(function(){o.setValue(l),o.validatedUrl=l,o.markInvalid()});case 4:case"end":return L.stop()}},d,this)}));function i(d){return t.apply(this,arguments)}return i}(),h.markValid=function(){this.inputElement.removeAttribute("required"),this.inputElement.removeAttribute("pattern"),document.formvalidator&&document.formvalidator.validate(this.inputElement)},h.markInvalid=function(){this.inputElement.setAttribute("required",""),this.inputElement.setAttribute("pattern","/^(http://INVALID/).+$/"),document.formvalidator&&document.formvalidator.validate(this.inputElement)},h.clearValue=function(){this.setValue(""),this.validatedUrl="",this.inputElement.removeAttribute("required"),this.inputElement.removeAttribute("pattern"),document.formvalidator&&document.formvalidator.validate(this.inputElement)},h.updatePreview=function(){var i=this;if(!(["true","static"].indexOf(this.preview)===-1||this.preview==="false"||!this.previewElement)&&this.preview){var d=this.inputElement.value,m=this.supportedExtensions;if(!d)this.buttonClearEl.style.display="none",this.previewElement.innerHTML=Joomla.sanitizeHtml('<span class="field-media-preview-icon"></span>');else{var o;this.buttonClearEl.style.display="",this.previewElement.innerHTML="";var l=nt(d).toLowerCase();m.images.includes(l)&&(o="images"),m.audios.includes(l)&&(o="audios"),m.videos.includes(l)&&(o="videos"),m.documents.includes(l)&&(o="documents");var f,E={images:function(){m.images.includes(l)&&(f=new Image,f.src=/http/.test(d)?d:Joomla.getOptions("system.paths").rootFull+d,f.setAttribute("alt",""))},audios:function(){m.audios.includes(l)&&(f=document.createElement("audio"),f.src=/http/.test(d)?d:Joomla.getOptions("system.paths").rootFull+d,f.setAttribute("controls",""))},videos:function(){if(m.videos.includes(l)){f=document.createElement("video");var O=document.createElement("source");O.src=/http/.test(d)?d:Joomla.getOptions("system.paths").rootFull+d,O.type=i.mimeType,f.setAttribute("controls",""),f.setAttribute("width",i.previewWidth),f.setAttribute("height",i.previewHeight),f.appendChild(O)}},documents:function(){m.documents.includes(l)&&(f=document.createElement("object"),f.data=/http/.test(d)?d:Joomla.getOptions("system.paths").rootFull+d,f.type=i.mimeType,f.setAttribute("width",i.previewWidth),f.setAttribute("height",i.previewHeight))}};if(this.givenType&&["images","audios","videos","documents"].includes(this.givenType))E[this.givenType]();else if(o&&["images","audios","videos","documents"].includes(o))E[o]();else return;this.previewElement.style.width=this.previewWidth,this.previewElement.appendChild(f)}}},Q(s,[{key:"type",get:function(){return this.getAttribute("type")},set:function(i){this.setAttribute("type",i)}},{key:"basePath",get:function(){return this.getAttribute("base-path")},set:function(i){this.setAttribute("base-path",i)}},{key:"rootFolder",get:function(){return this.getAttribute("root-folder")},set:function(i){this.setAttribute("root-folder",i)}},{key:"url",get:function(){return this.getAttribute("url")},set:function(i){this.setAttribute("url",i)}},{key:"modalContainer",get:function(){return this.getAttribute("modal-container")},set:function(i){this.setAttribute("modal-container",i)}},{key:"input",get:function(){return this.getAttribute("input")},set:function(i){this.setAttribute("input",i)}},{key:"buttonSelect",get:function(){return this.getAttribute("button-select")},set:function(i){this.setAttribute("button-select",i)}},{key:"buttonClear",get:function(){return this.getAttribute("button-clear")},set:function(i){this.setAttribute("button-clear",i)}},{key:"buttonSaveSelected",get:function(){return this.getAttribute("button-save-selected")},set:function(i){this.setAttribute("button-save-selected",i)}},{key:"modalWidth",get:function(){return parseInt(this.getAttribute("modal-width"),10)},set:function(i){this.setAttribute("modal-width",i)}},{key:"modalHeight",get:function(){return parseInt(this.getAttribute("modal-height"),10)},set:function(i){this.setAttribute("modal-height",i)}},{key:"previewWidth",get:function(){return parseInt(this.getAttribute("preview-width"),10)},set:function(i){this.setAttribute("preview-width",i)}},{key:"previewHeight",get:function(){return parseInt(this.getAttribute("preview-height"),10)},set:function(i){this.setAttribute("preview-height",i)}},{key:"preview",get:function(){return this.getAttribute("preview")},set:function(i){this.setAttribute("preview",i)}},{key:"previewContainer",get:function(){return this.getAttribute("preview-container")}}],[{key:"observedAttributes",get:function(){return["type","base-path","root-folder","url","modal-container","modal-width","modal-height","input","button-select","button-clear","button-save-selected","preview","preview-width","preview-height"]}}]),s}(R(HTMLElement));customElements.define("joomla-field-media",it)})();
